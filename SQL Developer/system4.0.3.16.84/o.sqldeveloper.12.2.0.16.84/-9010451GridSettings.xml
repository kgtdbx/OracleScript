<?xml version = '1.0' encoding = 'UTF-8'?>
<TableSettings class="oracle.dbtools.raptor.controls.grid.RaptorGridPersistedSettings" xmlns="http://xmlns.oracle.com/jdeveloper/110000/Table-attributes">
   <columnPositions class="java.util.ArrayList">
      <Item class="java.lang.String">CODE</Item>
      <Item class="java.lang.String">NAME</Item>
      <Item class="java.lang.String">LEI_CODE</Item>
      <Item class="java.lang.String">RESIDENCE</Item>
      <Item class="java.lang.String">SECTOR</Item>
      <Item class="java.lang.String">NACE_CODE</Item>
      <Item class="java.lang.String">TYPE</Item>
   </columnPositions>
   <columnWidths>
      <Item>75</Item>
      <Item>215</Item>
      <Item>145</Item>
      <Item>75</Item>
      <Item>376</Item>
      <Item>509</Item>
      <Item>47</Item>
   </columnWidths>
   <searchParams class="java.util.ArrayList"/>
   <sortClauses>
      <Item class="java.lang.String">1 asc</Item>
      <Item/>
   </sortClauses>
   <uniqueName>IdeConnections%23vhgstbclone_mimirwith stmt_sector as 
( 
select  'S.11.RAF'   as id, 'General governments' as value from dual union all 
select  'S.2.ERO'    as id, 'General governments' as value from dual union all 
select  'S.11.SAG'   as id, 'General governments' as value from dual union all 
select  'S.1311'     as id, 'General governments' as value from dual union all 

select  'S.122'      as id, 'Credit institutions' as value from dual union all 
select  'S.2.ERI'    as id, 'Credit institutions' as value from dual union all 

select  'S.122X'     as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.123'      as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.124'      as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.125'      as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.125X'     as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.126'      as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.127'      as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.128'      as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.129'      as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.2.ERF'    as id, 'Financial corporations other than credit institutions' as value from dual union all 
select  'S.2.ERV'    as id, 'Financial corporations other than credit institutions' as value from dual union all 

select  'S.11.IAN'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.ILA'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.ISJ'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.LAB'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.MAN'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.OFL'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.SJA'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.THA'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.THF'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.THH'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.11.VEN'   as id, 'Non-financial corporations' as value from dual union all 
select  'S.1313'     as id, 'Non-financial corporations' as value from dual union all 
select  'S.2.ERA'    as id, 'Non-financial corporations' as value from dual union all 

select  'S.121'      as id, 'Central banks' as value from dual union all 
select  'S.2.ERS'    as id, 'Central banks' as value from dual union all 

select  'S.14'       as id, 'Households'    as value from dual 
) 

, stmt_xbrl_dates as 
(select to_date(capital_date, 'DD.MM.YYYY') as capital_date,  
        to_date(htv_date, 'DD.MM.YYYY')     as htv_date  
  from  xbrl_dates 
) 

,stmt_total_reg_cap as 
( 
select total_regulatory_capital from utgardur.capital_info ci 
where ci.the_date = (select capital_date from stmt_xbrl_dates) 
and ci.consolidate_parent = 'Móðurfélag' 
) 

,stmt_crd_le_det as 
( 
select  
    cle.group_ssn                           as group_ssn, 
    cle.ssn                                 as ssn, 
    cle.group_name                          as group_name, 
    cle.cust_full_name                      as cust_full_name, 
    cle.credit_risk_exposure                as credit_risk_exposure, 
    cle.the_date                            as the_date, 
    cle.domicile_country_code_2l            as domicile_country_code_2l, 
    cle.central_bank_2014                   as central_bank_2014, 
    cle.sector_id                           as sector_id, 
    cle.segment_id                          as segment_id 
from mimir.v_crd_large_exposure_detail cle 
where cle.the_date = (select htv_date from stmt_xbrl_dates) 
) 

,stmt_main as 
( 

  select 
      nvl(cle.group_ssn,cle.ssn)              as "CODE", 
      nvl(cle.group_name,cle.cust_full_name)  as "NAME", 
      lei.lei_code                            as "LEI_CODE", 
      null                                    as "RESIDENCE", 
      null                                    as "SECTOR", 
      null                                    as "NACE_CODE", 
      null                                    as "TYPE" 
  from stmt_crd_le_det cle 
  left join lei_code lei on nvl(cle.group_ssn,cle.ssn) = lei.ssn 
  inner join ( 

    select 
    nvl(cle.group_ssn,cle.ssn) group_ssn 
    from stmt_crd_le_det cle 
    group by  nvl(cle.group_ssn,cle.ssn) 
 

  having sum(nvl(cle.credit_risk_exposure,0))/( select total_regulatory_capital from stmt_total_reg_cap) >= 0.1 
  ) stor on nvl(cle.group_ssn,cle.ssn) = stor.group_ssn 
  where 


  nvl(cle.group_ssn,cle.ssn) &lt;> cle.ssn 
  group by  nvl(cle.group_ssn,cle.ssn),nvl(cle.group_name,cle.cust_full_name),lei.lei_code 

  having sum(nvl(cle.credit_risk_exposure,0))/( select total_regulatory_capital from stmt_total_reg_cap) >= 0.1 
 
  UNION ALL 
 

  select 
  cle.ssn                                     as "CODE", 
  cle.cust_full_name                          as "NAME", 
  lei.lei_code                                as "LEI_CODE", 
  cle.domicile_country_code_2l                as "RESIDENCE", 

  case when cle.central_bank_2014 is null 
           then 'ATH' 
       else s.value 
  end                                         as "SECTOR", 
  nace.NACE_DESC                              as "NACE_CODE", 
  null                                        as "TYPE" 
  from stmt_crd_le_det cle 
  left join stmt_sector s on (cle.central_bank_2014 = s.id) 
  left join lei_code lei on (cle.ssn = lei.ssn) 

  left join utgardur.xbrl_le_nace_beta nace on nace.NACE = ( 
  case when central_bank_2014 in (select id from stmt_sector s where s.value = 'Financial corporations other than credit institutions') 
        then cle.sector_id||substr(cle.segment_id,0,2) 
       when central_bank_2014 in (select id from stmt_sector s where s.value = 'Non-financial corporations') 
        then cle.sector_id 
       else null 
  end) 
  inner join ( 

    select 
    nvl(cle.group_ssn,cle.ssn) group_ssn 
    from stmt_crd_le_det cle 
    where 1=1 
    group by nvl(cle.group_ssn,cle.ssn) 

  having sum(nvl(cle.credit_risk_exposure,0))/( select total_regulatory_capital from stmt_total_reg_cap) >= 0.1 
  ) stor on nvl(cle.group_ssn,cle.ssn) = stor.group_ssn 
  where 1=1 
  group by cle.ssn,cle.cust_full_name,lei.lei_code,cle.domicile_country_code_2l, 
    case when cle.central_bank_2014 is null 
            then 'ATH' 
    else s.value 
    end, 
    nace.NACE_DESC 
) 
select "CODE","NAME","LEI_CODE","RESIDENCE","SECTOR","NACE_CODE","TYPE" from stmt_main</uniqueName>
</TableSettings>
