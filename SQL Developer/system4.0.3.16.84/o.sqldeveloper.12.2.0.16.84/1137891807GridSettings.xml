<?xml version = '1.0' encoding = 'UTF-8'?>
<TableSettings class="oracle.dbtools.raptor.controls.grid.RaptorGridPersistedSettings" xmlns="http://xmlns.oracle.com/jdeveloper/110000/Table-attributes">
   <columnPositions class="java.util.ArrayList">
      <Item class="java.lang.String">DIM_TIME</Item>
      <Item class="java.lang.String">DIM_LOAN</Item>
      <Item class="java.lang.String">DIM_CUSTOMER</Item>
      <Item class="java.lang.String">DIM_LOAN_TYPE</Item>
      <Item class="java.lang.String">LOAN_TYPE</Item>
      <Item class="java.lang.String">DIM_GL_ACCOUNT</Item>
      <Item class="java.lang.String">LOAN_ID</Item>
      <Item class="java.lang.String">CONTRACT_NUMBER</Item>
      <Item class="java.lang.String">ORIGIN_DATE</Item>
      <Item class="java.lang.String">END_DATE</Item>
      <Item class="java.lang.String">PAYMENT_INTERVAL</Item>
      <Item class="java.lang.String">PAYMENTS_LEFT</Item>
      <Item class="java.lang.String">SOURCE_SYSTEM</Item>
      <Item class="java.lang.String">AGREEMENT_ID</Item>
      <Item class="java.lang.String">THE_DATE</Item>
   </columnPositions>
   <columnWidths>
      <Item>68</Item>
      <Item>82</Item>
      <Item>99</Item>
      <Item>101</Item>
      <Item>76</Item>
      <Item>111</Item>
      <Item>96</Item>
      <Item>121</Item>
      <Item>88</Item>
      <Item>71</Item>
      <Item>119</Item>
      <Item>100</Item>
      <Item>104</Item>
      <Item>96</Item>
      <Item>70</Item>
   </columnWidths>
   <searchParams class="java.util.ArrayList"/>
   <sortClauses>
      <Item class="java.lang.String">15 asc</Item>
      <Item/>
   </sortClauses>
   <uniqueName>IdeConnections%23vhgstbclone_kvasirwith the_date_stmt as 
(select the_date from valholl.dim_time  
where last_banking_day_of_month ='Yes' 
and the_date between date'2014-01-01' and date'2017-12-31' 
union  
select the_date from valholl.dim_time  
where last_banking_day_of_month ='Yes' 
and the_date between date'2013-12-01' and date'2013-12-31' 
union  
select the_date from valholl.dim_time  
where last_banking_day_of_month ='Yes' 
and the_date between date'2012-12-01' and date'2012-12-31') 
select  
	f.dim_time, 
	coalesce(naestu_gjalddagar.dim_loan,f.dim_loan) as dim_loan, 
	f.dim_customer, 
	f.dim_loan_type, 
	l.loan_type, 
	f.dim_gl_account, 
	l.id as loan_id, 
	nvl(l.contract_number,l.id) as contract_number, 
	l.origin_date, 
	l.end_date, 
	nvl(l.payment_interval,1) as payment_interval, 
	case 
       when l.payment_interval = 0 then 0 
       when l.end_date is null or l.end_date &lt; nvl(naestu_gjalddagar.naesti_gjalddagi, l.origin_date) then null 
	else ceil(months_between(l.end_date, nvl(naestu_gjalddagar.naesti_gjalddagi, l.origin_date))*(round(12/nvl(l.payment_interval,1)))/12)+1  
	end as payments_left, 
	l.source_system, 
	f.agreement_id, 
	f.the_date 
from valholl.fct_loan_balance f 
   left join 
   ( select cf.the_date,dim_loan,min(t.the_date) naesti_gjalddagi 
        from valholl.fct_loan_cashflow cf join valholl.dim_time t on cf.dim_time_transaction=t.dimension_key 
        where 
        cf.the_date in (select the_date from the_date_stmt) 
        and cf.active='Y' 
        and exists (select the_date from the_date_stmt ds where ds.the_date = t.the_date) 
	 group by cf.the_date,cf.dim_loan 
   ) naestu_gjalddagar on f.dim_loan=naestu_gjalddagar.dim_loan and f.the_date=naestu_gjalddagar.the_date 
left join valholl.dim_loan l on f.dim_loan=l.dimension_key   
left join valholl.dim_loan_type dlt on dlt.dimension_key=f.dim_loan_type 
left join valholl.dim_gl_account gl on gl.dimension_key=f.dim_gl_account 
where f.the_date in (select the_date from the_date_stmt) 
and dlt.subsystem_id in ('FAFNIR','KONDOR','APX','IF','SB','VX','FC','LN') 

and f.agreement_id = 53655</uniqueName>
</TableSettings>
